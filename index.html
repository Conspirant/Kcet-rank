```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KCET 2025 Rank Predictor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Futura&display=swap');
        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #0f172a, #1e3a8a);
            color: #e2e8f0;
            min-height: 100vh;
            padding: 2rem;
            position: relative;
            overflow-x: hidden;
        }
        .card {
            background: linear-gradient(145deg, #1e293b, #334155);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3), inset 0 0 10px rgba(59, 130, 246, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4), inset 0 0 15px rgba(59, 130, 246, 0.3);
        }
        .error {
            color: #f87171;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }
        .progress-bar {
            transition: width 0.5s ease-in-out;
            background: linear-gradient(90deg, #3b82f6, #a855f7);
        }
        .btn {
            position: relative;
            overflow: hidden;
            transition: transform 0.2s ease;
        }
        .btn:hover {
            transform: scale(1.05);
        }
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s ease, height 0.4s ease;
        }
        .btn:hover::after {
            width: 200px;
            height: 200px;
        }
        .disclaimer {
            background: rgba(234, 179, 8, 0.15);
            border-left: 4px solid #eab308;
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        .glow-text {
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        canvas#particles {
            position: fixed;
            top: 0;
            left: 0;
            z-index: -1;
            opacity: 0.3;
        }
        @media (max-width: 768px) {
            .card { padding: 1.5rem; }
            h1 { font-size: 2rem; }
        }
    </style>
</head>
<body>
    <!-- Particle Background -->
    <canvas id="particles"></canvas>

    <div class="max-w-6xl mx-auto relative z-10">
        <!-- Header -->
        <header class="text-center mb-12 slide-in">
            <h1 class="text-5xl md:text-6xl font-extrabold text-white glow-text mb-3">KCET 2025 Rank Predictor</h1>
            <p class="text-lg text-gray-300">Unlock Your Future with Precision and Style</p>
        </header>

        <!-- Disclaimer -->
        <div class="disclaimer mb-10 slide-in">
            <p>
                <strong>Disclaimer:</strong> This KCET 2025 Rank Predictor provides estimates based on historical data and simplified models. Actual ranks and cutoffs may vary due to exam changes, candidate performance, or KEA policies. Use for guidance only and verify with official KEA sources.
            </p>
        </div>

        <!-- Input Section -->
        <div class="card mb-10 slide-in">
            <h2 class="text-3xl font-bold mb-6 text-center glow-text">Enter Your Marks</h2>
            <div class="grid md:grid-cols-2 gap-8">
                <!-- PUC Marks -->
                <div>
                    <h3 class="text-xl font-semibold mb-4">PUC Marks (Out of 100)</h3>
                    <div class="space-y-5">
                        <div>
                            <label class="block text-sm font-medium">Physics</label>
                            <input type="number" id="pucPhysics" value="60" min="0" max="100" class="w-full bg-gray-900 p-3 rounded-lg border border-gray-700 focus:ring-2 focus:ring-blue-500 text-white">
                            <div id="pucPhysicsError" class="error hidden"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Chemistry</label>
                            <input type="number" id="pucChemistry" value="60" min="0" max="100" class="w-full bg-gray-900 p-3 rounded-lg border border-gray-700 focus:ring-2 focus:ring-blue-500 text-white">
                            <div id="pucChemistryError" class="error hidden"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Mathematics</label>
                            <input type="number" id="pucMath" value="60" min="0" max="100" class="w-full bg-gray-900 p-3 rounded-lg border border-gray-700 focus:ring-2 focus:ring-blue-500 text-white">
                            <div id="pucMathError" class="error hidden"></div>
                        </div>
                    </div>
                    <div class="mt-5">
                        <div class="flex justify-between text-sm">
                            <span>PUC Total %</span>
                            <span id="pucTotal">60%</span>
                        </div>
                        <div class="w-full bg-gray-800 h-4 rounded-full mt-2">
                            <div id="pucProgress" class="h-4 rounded-full progress-bar" style="width: 60%"></div>
                        </div>
                    </div>
                </div>
                <!-- KCET Marks -->
                <div>
                    <h3 class="text-xl font-semibold mb-4">KCET Marks (Out of 60)</h3>
                    <div class="space-y-5">
                        <div>
                            <label class="block text-sm font-medium">Physics</label>
                            <input type="number" id="kcetPhysics" value="40" min="0" max="60" class="w-full bg-gray-900 p-3 rounded-lg border border-gray-700 focus:ring-2 focus:ring-blue-500 text-white">
                            <div id="kcetPhysicsError" class="error hidden"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Chemistry</label>
                            <input type="number" id="kcetChemistry" value="40" min="0" max="60" class="w-full bg-gray-900 p-3 rounded-lg border border-gray-700 focus:ring-2 focus:ring-blue-500 text-white">
                            <div id="kcetChemistryError" class="error hidden"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Mathematics</label>
                            <input type="number" id="kcetMath" value="40" min="0" max="60" class="w-full bg-gray-900 p-3 rounded-lg border border-gray-700 focus:ring-2 focus:ring-blue-500 text-white">
                            <div id="kcetMathError" class="error hidden"></div>
                        </div>
                    </div>
                    <div class="mt-5">
                        <div class="flex justify-between text-sm">
                            <span>KCET Total %</span>
                            <span id="kcetTotal">66.67%</span>
                        </div>
                        <div class="w-full bg-gray-800 h-4 rounded-full mt-2">
                            <div id="kcetProgress" class="h-4 rounded-full progress-bar" style="width: 66.67%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Category and Branch Preferences -->
            <div class="mt-8 grid md:grid-cols-2 gap-8">
                <div>
                    <label class="block text-sm font-medium mb-2">Category</label>
                    <select id="category" class="w-full bg-gray-900 p-3 rounded-lg border border-gray-700 focus:ring-2 focus:ring-blue-500 text-white">
                        <option value="GM">General Merit</option>
                        <option value="OBC">OBC</option>
                        <option value="SC">SC</option>
                        <option value="ST">ST</option>
                    </select>
                    <p class="text-xs text-gray-400 mt-2">
                        <strong>Note:</strong> Category is used only for estimating college cutoffs, not for rank calculation, as per KEA guidelines.
                    </p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Preferred Branches</label>
                    <select id="branches" multiple class="w-full bg-gray-900 p-3 rounded-lg border border-gray-700 focus:ring-2 focus:ring-blue-500 text-white">
                        <option value="Computer Science">Computer Science</option>
                        <option value="Electronics">Electronics</option>
                        <option value="Mechanical">Mechanical</option>
                        <option value="Civil">Civil</option>
                    </select>
                </div>
            </div>
            <!-- Performance Analytics -->
            <div class="mt-8">
                <h3 class="text-xl font-semibold mb-4">Performance Snapshot</h3>
                <div id="analytics" class="grid md:grid-cols-3 gap-4"></div>
            </div>
            <!-- Live Rank -->
            <div class="mt-8 text-center">
                <h3 class="text-xl font-semibold glow-text">Live Rank Preview</h3>
                <p id="liveRank" class="text-3xl font-bold text-blue-300">--</p>
            </div>
            <!-- Buttons -->
            <div class="mt-8 flex flex-wrap justify-center gap-4">
                <button id="calculate" class="btn bg-blue-600 hover:bg-blue-700 text-white py-3 px-8 rounded-lg">Calculate Rank</button>
                <button id="save" class="btn bg-green-600 hover:bg-green-700 text-white py-3 px-8 rounded-lg">Save Inputs</button>
                <button id="studyPlan" class="btn bg-purple-600 hover:bg-purple-700 text-white py-3 px-8 rounded-lg">Generate Study Plan</button>
            </div>
        </div>

        <!-- Result Section -->
        <div id="result" class="card mb-10 hidden slide-in">
            <h2 class="text-3xl font-bold mb-6 text-center glow-text">Your Predicted Rank</h2>
            <div class="text-center mb-8">
                <p class="text-5xl font-extrabold text-blue-300" id="finalRank">--</p>
                <p class="text-gray-300 text-lg">Estimated Rank Range: <span id="rankRange">-- to --</span></p>
                <p class="text-gray-300 text-lg">Category: <span id="categoryDisplay">GM</span></p>
            </div>
            <div class="mb-8">
                <h3 class="text-xl font-semibold mb-4">Interpretation</h3>
                <p id="interpretation" class="text-gray-200">Enter marks to see your rank.</p>
            </div>
            <!-- Calculation Breakdown -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold mb-4">How Your Rank Was Calculated</h3>
                <div class="bg-gray-900 p-6 rounded-lg">
                    <p class="mb-3"><strong>Step 1: PUC Percentage</strong></p>
                    <p id="stepPuc" class="text-gray-300">Calculated from Physics, Chemistry, Math marks.</p>
                    <p class="mt-3 mb-3"><strong>Step 2: KCET Percentage</strong></p>
                    <p id="stepKcet" class="text-gray-300">Calculated from KCET marks out of 180.</p>
                    <p class="mt-3 mb-3"><strong>Step 3: Composite Score</strong></p>
                    <p id="stepComposite" class="text-gray-300">50% PUC + 50% KCET.</p>
                    <p class="mt-3 mb-3"><strong>Step 4: Rank Estimation</strong></p>
                    <p id="stepRank" class="text-gray-300">Based on historical score-to-rank data.</p>
                </div>
            </div>
            <!-- Score vs. Rank Chart -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold mb-4">Score vs. Rank Curve</h3>
                <canvas id="rankChart" class="bg-gray-900 p-4 rounded-lg"></canvas>
            </div>
            <!-- Cutoff Trends -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold mb-4">Historical Cutoff Trends (2022–2024)</h3>
                <select id="trendCollege" class="w-full md:w-1/3 bg-gray-900 p-3 rounded-lg border border-gray-700 mb-4">
                    <option value="RV College of Engineering">RV College of Engineering</option>
                    <option value="PES University">PES University</option>
                </select>
                <select id="trendBranch" class="w-full md:w-1/3 bg-gray-900 p-3 rounded-lg border border-gray-700 mb-4"></select>
                <canvas id="cutoffChart" class="bg-gray-900 p-4 rounded-lg"></canvas>
            </div>
            <div class="flex flex-wrap justify-center gap-4">
                <button id="edit" class="btn bg-gray-600 hover:bg-gray-700 text-white py-3 px-8 rounded-lg">Edit Marks</button>
                <button id="viewColleges" class="btn bg-green-600 hover:bg-green-700 text-white py-3 px-8 rounded-lg">View Colleges</button>
                <button id="share" class="btn bg-indigo-600 hover:bg-indigo-700 text-white py-3 px-8 rounded-lg">Share Results</button>
                <button id="export" class="btn bg-red-600 hover:bg-red-700 text-white py-3 px-8 rounded-lg">Export PDF</button>
            </div>
        </div>

        <!-- College Suggestions -->
        <div id="colleges" class="card hidden slide-in">
            <h2 class="text-3xl font-bold mb-6 text-center glow-text">College Suggestions</h2>
            <div id="collegeList" class="grid md:grid-cols-2 gap-6"></div>
            <!-- Map Placeholder -->
            <div class="mt-8">
                <h3 class="text-xl font-semibold mb-4">College Locations</h3>
                <iframe class="w-full h-64 rounded-lg" src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3151.835434509374!2d144.9537363153167!3d-37.81627927975159!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2zMzfCsDQ5JzQ1LjQiUyAxNDTCsDU3JzEzLjUiRQ!5e0!3m2!1sen!2sau!4v1610000000000"></iframe>
            </div>
            <div class="mt-6 flex justify-center gap-4">
                <button id="backToResult" class="btn bg-gray-600 hover:bg-gray-700 text-white py-3 px-8 rounded-lg">Back to Result</button>
            </div>
        </div>

        <!-- Modal for Study Plan -->
        <div id="modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
            <div class="card max-w-lg w-full p-6">
                <div class="flex justify-between mb-4">
                    <h2 id="modalTitle" class="text-xl font-bold glow-text"></h2>
                    <button id="closeModal" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                </div>
                <div id="modalContent" class="text-gray-200"></div>
                <div id="modalActions" class="mt-4 flex justify-end gap-4"></div>
            </div>
        </div>

    <script>
        // College Data
        const colleges = [
            {
                name: "RV College of Engineering",
                branches: [
                    { name: "Computer Science", cutoff: { GM: 1000, OBC: 1500, SC: 5000, ST: 6000 }, trends: { 2022: 1200, 2023: 1100, 2024: 1000 } },
                    { name: "Electronics", cutoff: { GM: 3000, OBC: 4000, SC: 8000, ST: 9000 }, trends: { 2022: 3500, 2023: 3200, 2024: 3000 } }
                ]
            },
            {
                name: "PES University",
                branches: [
                    { name: "Computer Science", cutoff: { GM: 800, OBC: 1200, SC: 4000, ST: 4500 }, trends: { 2022: 900, 2023: 850, 2024: 800 } },
                    { name: "Mechanical", cutoff: { GM: 5000, OBC: 6000, SC: 10000, ST: 11000 }, trends: { 2022: 5500, 2023: 5200, 2024: 5000 } }
                ]
            }
        ];

        // Rank Estimation Table
        const rankTable = [
            { score: 95, rank: 500 },
            { score: 90, rank: 1000 },
            { score: 85, rank: 3000 },
            { score: 80, rank: 5000 },
            { score: 75, rank: 10000 },
            { score: 70, rank: 15000 },
            { score: 60, rank: 30000 },
            { score: 50, rank: 50000 },
            { score: 40, rank: 80000 }
        ];

        // DOM Elements
        const els = {
            inputs: {
                pucPhysics: document.getElementById('pucPhysics'),
                pucChemistry: document.getElementById('pucChemistry'),
                pucMath: document.getElementById('pucMath'),
                kcetPhysics: document.getElementById('kcetPhysics'),
                kcetChemistry: document.getElementById('kcetChemistry'),
                kcetMath: document.getElementById('kcetMath'),
                category: document.getElementById('category'),
                branches: document.getElementById('branches')
            },
            errors: {
                pucPhysics: document.getElementById('pucPhysicsError'),
                pucChemistry: document.getElementById('pucChemistryError'),
                pucMath: document.getElementById('pucMathError'),
                kcetPhysics: document.getElementById('kcetPhysicsError'),
                kcetChemistry: document.getElementById('kcetChemistryError'),
                kcetMath: document.getElementById('kcetMathError')
            },
            totals: {
                puc: document.getElementById('pucTotal'),
                pucProgress: document.getElementById('pucProgress'),
                kcet: document.getElementById('kcetTotal'),
                kcetProgress: document.getElementById('kcetProgress')
            },
            analytics: document.getElementById('analytics'),
            liveRank: document.getElementById('liveRank'),
            result: document.getElementById('result'),
            finalRank: document.getElementById('finalRank'),
            rankRange: document.getElementById('rankRange'),
            categoryDisplay: document.getElementById('categoryDisplay'),
            interpretation: document.getElementById('interpretation'),
            stepPuc: document.getElementById('stepPuc'),
            stepKcet: document.getElementById('stepKcet'),
            stepComposite: document.getElementById('stepComposite'),
            stepRank: document.getElementById('stepRank'),
            trendCollege: document.getElementById('trendCollege'),
            trendBranch: document.getElementById('trendBranch'),
            colleges: document.getElementById('colleges'),
            collegeList: document.getElementById('collegeList'),
            calculate: document.getElementById('calculate'),
            save: document.getElementById('save'),
            studyPlan: document.getElementById('studyPlan'),
            edit: document.getElementById('edit'),
            viewColleges: document.getElementById('viewColleges'),
            share: document.getElementById('share'),
            export: document.getElementById('export'),
            backToResult: document.getElementById('backToResult'),
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modalTitle'),
            modalContent: document.getElementById('modalContent'),
            modalActions: document.getElementById('modalActions'),
            closeModal: document.getElementById('closeModal')
        };

        let rankChart, cutoffChart;
        let currentRank = 0;
        let currentScore = 0;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupInputs();
            setupButtons();
            setupCharts();
            setupParticles();
            updateTotals();
            updateAnalytics();
            updateLiveRank();
            updateTrendBranchOptions();
        });

        // Particle Background
        function setupParticles() {
            const canvas = document.getElementById('particles');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const particles = [];
            for (let i = 0; i < 100; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    radius: Math.random() * 2 + 1,
                    vx: Math.random() * 0.5 - 0.25,
                    vy: Math.random() * 0.5 - 0.25
                });
            }

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'rgba(59, 130, 246, 0.5)';
                particles.forEach(p => {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fill();
                    p.x += p.vx;
                    p.y += p.vy;
                    if (p.x < 0 || p.x > canvas.width) p.vx *= -1;
                    if (p.y < 0 || p.y > canvas.height) p.vy *= -1;
                });
                requestAnimationFrame(animate);
            }
            animate();
        }

        // Input Handling
        function setupInputs() {
            const inputConfigs = [
                { el: els.inputs.pucPhysics, error: els.errors.pucPhysics, max: 100 },
                { el: els.inputs.pucChemistry, error: els.errors.pucChemistry, max: 100 },
                { el: els.inputs.pucMath, error: els.errors.pucMath, max: 100 },
                { el: els.inputs.kcetPhysics, error: els.errors.kcetPhysics, max: 60 },
                { el: els.inputs.kcetChemistry, error: els.errors.kcetChemistry, max: 60 },
                { el: els.inputs.kcetMath, error: els.errors.kcetMath, max: 60 }
            ];

            inputConfigs.forEach(({ el, error, max }) => {
                el.addEventListener('input', () => {
                    const value = parseFloat(el.value) || 0;
                    if (value < 0 || value > max || isNaN(value)) {
                        error.textContent = `Enter a value between 0 and ${max}`;
                        error.classList.remove('hidden');
                    } else {
                        error.classList.add('hidden');
                        el.value = value;
                    }
                    updateTotals();
                    updateAnalytics();
                    updateLiveRank();
                });
            });

            els.inputs.branches.addEventListener('change', updateAnalytics);
            els.inputs.category.addEventListener('change', updateAnalytics);
        }

        function updateTotals() {
            const pucTotal = (
                (parseFloat(els.inputs.pucPhysics.value) || 0) +
                (parseFloat(els.inputs.pucChemistry.value) || 0) +
                (parseFloat(els.inputs.pucMath.value) || 0)
            ) / 3;
            els.totals.puc.textContent = pucTotal.toFixed(2) + '%';
            els.totals.pucProgress.style.width = pucTotal.toFixed(2) + '%';

            const kcetTotal = (
                (parseFloat(els.inputs.kcetPhysics.value) || 0) +
                (parseFloat(els.inputs.kcetChemistry.value) || 0) +
                (parseFloat(els.inputs.kcetMath.value) || 0)
            ) / 180 * 100;
            els.totals.kcet.textContent = kcetTotal.toFixed(2) + '%';
            els.totals.kcetProgress.style.width = kcetTotal.toFixed(2) + '%';
        }

        // Performance Analytics
        function updateAnalytics() {
            const subjects = [
                { name: 'PUC Physics', value: parseFloat(els.inputs.pucPhysics.value) || 0, max: 100 },
                { name: 'PUC Chemistry', value: parseFloat(els.inputs.pucChemistry.value) || 0, max: 100 },
                { name: 'PUC Math', value: parseFloat(els.inputs.pucMath.value) || 0, max: 100 },
                { name: 'KCET Physics', value: parseFloat(els.inputs.kcetPhysics.value) || 0, max: 60 },
                { name: 'KCET Chemistry', value: parseFloat(els.inputs.kcetChemistry.value) || 0, max: 60 },
                { name: 'KCET Math', value: parseFloat(els.inputs.kcetMath.value) || 0, max: 60 }
            ];

            els.analytics.innerHTML = '';
            subjects.forEach(subject => {
                const percent = (subject.value / subject.max) * 100;
                const label = percent >= 80 ? 'Excellent' : percent >= 60 ? 'Good' : percent >= 40 ? 'Average' : 'Needs Improvement';
                const color = percent >= 80 ? 'bg-green-600' : percent >= 60 ? 'bg-blue-600' : percent >= 40 ? 'bg-yellow-600' : 'bg-red-600';
                const div = document.createElement('div');
                div.className = 'bg-gray-900 p-4 rounded-lg';
                div.innerHTML = `
                    <p class="font-semibold">${subject.name}</p>
                    <p class="text-sm">${percent.toFixed(2)}% - ${label}</p>
                    <div class="w-full bg-gray-800 h-2 rounded-full mt-2">
                        <div class="${color} h-2 rounded-full" style="width: ${percent}%"></div>
                    </div>
                `;
                els.analytics.appendChild(div);
            });
        }

        // Rank Calculation
        function calculateCompositeScore() {
            const pucPercent = (
                (parseFloat(els.inputs.pucPhysics.value) || 0) +
                (parseFloat(els.inputs.pucChemistry.value) || 0) +
                (parseFloat(els.inputs.pucMath.value) || 0)
            ) / 3;
            const kcetPercent = (
                (parseFloat(els.inputs.kcetPhysics.value) || 0) +
                (parseFloat(els.inputs.kcetChemistry.value) || 0) +
                (parseFloat(els.inputs.kcetMath.value) || 0)
            ) / 180 * 100;
            return { puc: pucPercent, kcet: kcetPercent, composite: (pucPercent * 0.5) + (kcetPercent * 0.5) };
        }

        function estimateRank(score) {
            if (score >= rankTable[0].score) return rankTable[0].rank;
            if (score <= rankTable[rankTable.length - 1].score) return rankTable[rankTable.length - 1].rank;

            for (let i = 0; i < rankTable.length - 1; i++) {
                const high = rankTable[i];
                const low = rankTable[i + 1];
                if (score <= high.score && score > low.score) {
                    const fraction = (high.score - score) / (high.score - low.score);
                    return Math.round(high.rank + fraction * (low.rank - high.rank));
                }
            }
            return 100000;
        }

        function updateLiveRank() {
            const { composite } = calculateCompositeScore();
            els.liveRank.textContent = estimateRank(composite).toLocaleString();
        }

        function calculateRank() {
            if (Object.values(els.errors).some(error => !error.classList.contains('hidden'))) {
                alert('Please correct input errors.');
                return;
            }

            const scores = calculateCompositeScore();
            currentScore = scores.composite;
            currentRank = estimateRank(currentScore);

            // Update Result
            els.finalRank.textContent = currentRank.toLocaleString();
            els.rankRange.textContent = `${(currentRank * 0.9).toFixed(0)} to ${(currentRank * 1.1).toFixed(0)}`;
            els.categoryDisplay.textContent = els.inputs.category.value;
            els.interpretation.textContent = currentRank < 2000 ? 'Outstanding! Top-tier colleges like RVCE are within reach.' : currentRank < 10000 ? 'Great! Competitive colleges and branches available.' : 'Good! Explore Tier-2/3 colleges or less competitive branches.';

            // Update Calculation Steps
            els.stepPuc.textContent = `(${els.inputs.pucPhysics.value} + ${els.inputs.pucChemistry.value} + ${els.inputs.pucMath.value}) / 3 = ${scores.puc.toFixed(2)}%`;
            els.stepKcet.textContent = `(${els.inputs.kcetPhysics.value} + ${els.inputs.kcetChemistry.value} + ${els.inputs.kcetMath.value}) / 180 * 100 = ${scores.kcet.toFixed(2)}%`;
            els.stepComposite.textContent = `(${scores.puc.toFixed(2)} * 0.5) + (${scores.kcet.toFixed(2)} * 0.5) = ${currentScore.toFixed(2)}%`;
            els.stepRank.textContent = `Score ${currentScore.toFixed(2)}% maps to rank ~${currentRank.toLocaleString()} (interpolated from historical data).`;

            // Update Charts
            rankChart.data.datasets[0].data = rankTable.map(entry => entry.rank);
            rankChart.data.datasets[1].data = rankTable.map(entry => entry.score === Math.round(currentScore) ? currentRank : null);
            rankChart.update();
            updateCutoffChart();

            // Show Result
            els.result.classList.remove('hidden');
            els.colleges.classList.add('hidden');
        }

        // Charts
        function setupCharts() {
            rankChart = new Chart(document.getElementById('rankChart'), {
                type: 'line',
                data: {
                    labels: rankTable.map(entry => entry.score + '%'),
                    datasets: [
                        {
                            label: 'Rank Curve',
                            data: rankTable.map(entry => entry.rank),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Your Rank',
                            data: [],
                            borderColor: '#eab308',
                            backgroundColor: '#eab308',
                            pointRadius: 8,
                            pointHoverRadius: 12,
                            showLine: false
                        }
                    ]
                },
                options: {
                    scales: {
                        x: { title: { display: true, text: 'Composite Score (%)', color: '#e2e8f0' } },
                        y: { title: { display: true, text: 'Rank', color: '#e2e8f0' }, beginAtZero: false }
                    },
                    plugins: { legend: { labels: { color: '#e2e8f0' } } }
                }
            });

            cutoffChart = new Chart(document.getElementById('cutoffChart'), {
                type: 'line',
                data: {
                    labels: ['2022', '2023', '2024'],
                    datasets: [{
                        label: 'Cutoff Rank',
                        data: [],
                        borderColor: '#a855f7',
                        backgroundColor: 'rgba(168, 85, 247, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    scales: {
                        x: { title: { display: true, text: 'Year', color: '#e2e8f0' } },
                        y: { title: { display: true, text: 'Cutoff Rank', color: '#e2e8f0' }, beginAtZero: false }
                    },
                    plugins: { legend: { labels: { color: '#e2e8f0' } } }
                }
            });
        }

        function updateTrendBranchOptions() {
            const collegeName = els.trendCollege.value;
            const college = colleges.find(c => c.name === collegeName);
            els.trendBranch.innerHTML = college.branches.map(b => `<option value="${b.name}">${b.name}</option>`).join('');
            updateCutoffChart();
        }

        function updateCutoffChart() {
            const collegeName = els.trendCollege.value;
            const branchName = els.trendBranch.value;
            const college = colleges.find(c => c.name === collegeName);
            const branch = college.branches.find(b => b.name === branchName);
            cutoffChart.data.datasets[0].data = [branch.trends[2022], branch.trends[2023], branch.trends[2024]];
            cutoffChart.update();
        }

        // College Suggestions
        function renderColleges() {
            els.collegeList.innerHTML = '';
            const category = els.inputs.category.value;
            const selectedBranches = Array.from(els.inputs.branches.selectedOptions).map(opt => opt.value);
            colleges.forEach(college => {
                const matchedBranches = college.branches.filter(b => selectedBranches.length === 0 || selectedBranches.includes(b.name));
                if (matchedBranches.length === 0) return;
                const div = document.createElement('div');
                div.className = 'bg-gray-900 p-5 rounded-lg';
                div.innerHTML = `
                    <h3 class="text-lg font-semibold mb-3">${college.name}</h3>
                    ${matchedBranches.map(b => `
                        <p class="text-gray-300">${b.name}: Cutoff ${b.cutoff[category].toLocaleString()} (${b.cutoff[category] > currentRank ? 'Challenging' : 'Likely'})</p>
                    `).join('')}
                    <button class="mt-3 btn bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg" onclick="showCollegeDetails('${college.name}')">View Details</button>
                `;
                els.collegeList.appendChild(div);
            });
            els.colleges.classList.remove('hidden');
            els.result.classList.add('hidden');
        }

        function showCollegeDetails(name) {
            const college = colleges.find(c => c.name === name);
            els.modalTitle.textContent = college.name;
            els.modalContent.innerHTML = `
                <p class="mb-2"><strong>Branches Available:</strong></p>
                <ul class="list-disc pl-5">
                    ${college.branches.map(b => `<li>${b.name}: Cutoff ${b.cutoff[els.inputs.category.value].toLocaleString()}</li>`).join('')}
                </ul>
            `;
            els.modalActions.innerHTML = `
                <button class="btn bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg" onclick="els.modal.classList.add('hidden')">Close</button>
            `;
            els.modal.classList.remove('hidden');
        }

        // Study Plan
        function generateStudyPlan() {
            const subjects = [
                { name: 'PUC Physics', value: parseFloat(els.inputs.pucPhysics.value) || 0, max: 100 },
                { name: 'PUC Chemistry', value: parseFloat(els.inputs.pucChemistry.value) || 0, max: 100 },
                { name: 'PUC Math', value: parseFloat(els.inputs.pucMath.value) || 0, max: 100 },
                { name: 'KCET Physics', value: parseFloat(els.inputs.kcetPhysics.value) || 0, max: 60 },
                { name: 'KCET Chemistry', value: parseFloat(els.inputs.kcetChemistry.value) || 0, max: 60 },
                { name: 'KCET Math', value: parseFloat(els.inputs.kcetMath.value) || 0, max: 60 }
            ];
            const weak = subjects.filter(s => (s.value / s.max) * 100 < 60);

            els.modalTitle.textContent = 'Personalized Study Plan';
            els.modalContent.innerHTML = `
                <p class="mb-4">Focus on these areas to boost your KCET rank:</p>
                ${weak.length > 0 ? `
                    <h3 class="font-semibold mb-2">Weak Subjects:</h3>
                    <ul class="list-disc pl-5 mb-4">
                        ${weak.map(s => `<li>${s.name}: Allocate 2 extra hours daily.</li>`).join('')}
                    </ul>
                ` : '<p>All subjects are strong! Maintain consistency.</p>'}
                <h3 class="font-semibold mb-2">Daily Schedule:</h3>
                <ul class="list-disc pl-5">
                    <li>4 hours: Core subject revision</li>
                    <li>2 hours: Solve past KCET papers</li>
                    <li>1 hour: Mock tests</li>
                    <li>1 hour: Formula review</li>
                </ul>
            `;
            els.modalActions.innerHTML = `
                <button class="btn bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg" onclick="els.modal.classList.add('hidden')">Close</button>
                <button class="btn bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg" onclick="exportStudyPlan()">Export Plan</button>
            `;
            els.modal.classList.remove('hidden');
        }

        function exportStudyPlan() {
            const element = document.createElement('div');
            element.className = 'p-4';
            element.innerHTML = `
                <h1 class="text-2xl font-bold">KCET 2025 Study Plan</h1>
                ${els.modalContent.innerHTML}
            `;
            html2pdf().from(element).save('kcet_study_plan.pdf');
        }

        // Button Actions
        function setupButtons() {
            els.calculate.addEventListener('click', calculateRank);
            els.save.addEventListener('click', () => {
                const data = {
                    pucPhysics: els.inputs.pucPhysics.value,
                    pucChemistry: els.inputs.pucChemistry.value,
                    pucMath: els.inputs.pucMath.value,
                    kcetPhysics: els.inputs.kcetPhysics.value,
                    kcetChemistry: els.inputs.kcetChemistry.value,
                    kcetMath: els.inputs.kcetMath.value,
                    category: els.inputs.category.value,
                    branches: Array.from(els.inputs.branches.selectedOptions).map(opt => opt.value)
                };
                localStorage.setItem('kcetData', JSON.stringify(data));
                alert('Inputs saved!');
            });
            els.studyPlan.addEventListener('click', generateStudyPlan);
            els.edit.addEventListener('click', () => {
                els.result.classList.add('hidden');
                els.colleges.classList.add('hidden');
            });
            els.viewColleges.addEventListener('click', renderColleges);
            els.share.addEventListener('click', () => {
                alert('Shareable URL: kcet2025.com/rank/' + currentRank);
            });
            els.export.addEventListener('click', () => {
                const element = document.createElement('div');
                element.className = 'p-4';
                element.innerHTML = `
                    <h1 class="text-2xl font-bold">KCET 2025 Rank Prediction</h1>
                    <p><strong>Rank:</strong> ${els.finalRank.textContent}</p>
                    <p><strong>Range:</strong> ${els.rankRange.textContent}</p>
                    <p><strong>Category:</strong> ${els.categoryDisplay.textContent}</p>
                    <p><strong>PUC %:</strong> ${els.stepPuc.textContent.split('=')[1].trim()}</p>
                    <p><strong>KCET %:</strong> ${els.stepKcet.textContent.split('=')[1].trim()}</p>
                    <p><strong>Composite Score:</strong> ${els.stepComposite.textContent.split('=')[1].trim()}</p>
                    <p><strong>Disclaimer:</strong> This is an estimate based on historical data.</p>
                `;
                html2pdf().from(element).save('kcet_rank_prediction.pdf');
            });
            els.backToResult.addEventListener('click', () => {
                els.colleges.classList.add('hidden');
                els.result.classList.remove('hidden');
            });
            els.closeModal.addEventListener('click', () => els.modal.classList.add('hidden'));
            els.trendCollege.addEventListener('change', updateTrendBranchOptions);
            els.trendBranch.addEventListener('change', updateCutoffChart);
        }
    </script>
</body>
</html>
